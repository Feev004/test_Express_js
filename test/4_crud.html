<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
    }
    input {
      margin: 5px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 8px 12px;
      background-color: #2c3e50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn {
      margin-bottom: 20px;
      text-align: center;
    }
    table {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    thead {
      background-color: #2c3e50;
      color: white;
    }
    td,
    th {
      text-align: center;
    }
  </style>
  <body>
    <h2>จัดการระบบสินค้า</h2>
    <div class="btn">
      <input type="text" id="pName" placeholder="ชื่อสินค้า" />
      <input type="number" id="pPrice" placeholder="ราคา" />
      <!-- <button onclick="addProduct()">เพิ่มสินค้า</button> -->
      <button id="submitBtn" onclick="handleSave()">เพิ่มสินค้า</button>
      <button id="cancelBtn" onclick="resetForm()">ยกเลิก</button>
      <!--จำ onclick ไว้ -->
    </div>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>ชื่อสินค้า</th>
          <th>ราคา</th>
          <th>จัดการ</th>
        </tr>
      </thead>
      <tbody id="product-list"></tbody>
    </table>
    <script>
      const apiURL = "http://localhost:3000/products";
      let isEditMode = false;
      let currentEditId = null;
      async function loadProducts() {
        try {
          const response = await fetch(apiURL);
          const data = await response.json();
          renderTable(data);
        } catch (error) {
          console.error("เกิดข้อผิดพลาด:", error);
        }
      }
      async function addProduct(name, price) {
        // const name = document.getElementById("pName").value;
        // const price = document.getElementById("pPrice").value;
        try {
          await fetch(apiURL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: name, price: price }),
          });
          document.getElementById("pName").value = "";
          document.getElementById("pPrice").value = "";
          loadProducts();
        } catch (error) {
          alert("ไม่สามารถเพิ่มข้อมูลได้");
        }
      }
      async function deleteProduct(id) {
        if (confirm("คุณแน่ใจหรือไม่ ว่าต้องการลบข้อมูลนี้?")) {
          try {
            const response = await fetch(`${apiURL}/${id}`, {
              method: "DELETE",
            });
            if (response.ok) {
              alert("ลบข้อมูลสำเร็จ");
              loadProducts(); // โหลดข้อมูลใหม่เพื่ออัปเดตตาราง
            } else {
              alert("ลบข้อมูลไม่สำเร็จ");
            }
          } catch (error) {
            console.error("เกิดข้อผิดพลาดในการลบ:", error);
          }
        }
      }

      async function handleSave() {
        const name = document.getElementById("pName").value;
        const price = document.getElementById("pPrice").value;
        if (isEditMode) {
          await updateProduct(currentEditId, name, price);
        } else {
          await addProduct(name, price);
        }
      }

      function prepareEdit(id, name, price) {
        isEditMode = true;
        currentEditId = id;
        document.getElementById("pName").value = name;
        document.getElementById("pPrice").value = price;
        document.getElementById("submitBtn").innerText = "แก้ไขข้อมูล";
        document.getElementById("cancelBtn").style.display = "inline"; // แสดงปุ่ม ยกเลิก
      }

      async function updateProduct(id, name, price) {
        try {
          const response = await fetch(`${apiURL}/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, price }),
          });
          if (response.ok) {
            alert("แก้ไขข้อมูลสำเร็จ");
            resetForm();
            loadProducts();
          }
        } catch (error) {
          console.error("Update error:", error);
        }
      }

      function resetForm() {
        isEditMode = false;
        currentEditId = null;
        document.getElementById("pName").value = "";
        document.getElementById("pPrice").value = "";
        document.getElementById("submitBtn").innerText = "เพิ่มสินค้า";
        document.getElementById("cancelBtn").style.display = "none"; // ซ่อนปุ่ม ยกเลิก
      }

      async function prepareEdit(id, name, price) {
        if (confirm("คุณแน่ใจหรือไม่ ว่าต้องการแก้ไขข้อมูลนี้?")) {
          try {
            const response = await fetch(`${apiURL}/${id}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, price }),
            });
            if (response.ok) {
              alert("แก้ไขข้อมูลสำเร็จ");
              resetForm();
              loadProducts(); // โหลดข้อมูลใหม่เพื่ออัปเดตตาราง
            } else {
              alert("แก้ไขข้อมูลไม่สำเร็จ");
            }
          } catch (error) {
            console.error("เกิดข้อผิดพลาดในการแก้ไข:", error);
          }
        }
      }

      function renderTable(data) {
        const tbody = document.getElementById("product-list");
        let html = "";
        data.forEach((item) => {
          html += `<tr>
                  <td>${item.id}</td>
                  <td>${item.name}</td>
                  <td>${item.price}</td>
                  <td>
                    <a href="#" onclick="prepareEdit(${item.id}, '${item.name}', ${item.price}); return false;" style="color: blue;">แก้ไข</a> |
                    <a href="#" onclick="deleteProduct(${item.id}); return false;" style="color: red;">ลบข้อมูล</a>
                  </td>
                  </tr>`;
        });
        tbody.innerHTML = html;
      }
      // โหลดข้อมูลครั้งแรกเมื่อเปิดหน้าเว็บ
      loadProducts();
    </script>
  </body>
</html>
